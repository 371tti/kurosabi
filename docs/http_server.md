# kurosabi HTTPサーバ構成

kurosabiフレームワークのHTTPサーバは以下のような構成になっています。

## 構成概要

- **サーバエントリポイント**: `src/server/kurosabi.rs`
    - サーバの起動やリクエスト受信のメイン処理を担当します。
- **ルーティング**: `src/router/`
    - リクエストパスのマッチングや、対応するハンドラの呼び出しを行います。
- **リクエスト/レスポンス処理**: `src/request/`, `src/response/`
    - HTTPリクエスト・レスポンスの型定義やパース、生成処理を担います。
- **ミドルウェア**: `src/middleware/`
    - リクエスト処理の前後に任意の処理（認証、ロギング等）を挟むことができます。
- **ワーカースレッド/非同期処理**: `src/server/worker.rs`
    - 複数リクエストの並列処理やバックグラウンド処理を管理します。
- **ユーティリティ**: `src/utils/`
    - ヘッダ、メソッド、ステータスコード等の共通処理をまとめています。
- **エラー処理**: `src/error.rs`
    - サーバ全体のエラー管理・定義を行います。

## リクエストからレスポンスまでの流れ

1. サーバが起動し、リクエストを受信します。
2. ルーターでリクエストパスに応じたハンドラを決定します。
3. 必要に応じてミドルウェアが処理を挟みます。
4. ハンドラでリクエストを処理し、レスポンスを生成します。
5. レスポンスがクライアントに返却されます。

## 受信スレッドとワーカースレッドの連携

- 受信スレッド（メインスレッド）は、クライアントからの新規接続を受け付ける役割を持ちます。
- 受信スレッドは、受信した接続（TcpConnection）をメインのグローバルキュー（`grobal_queue`）に追加します。
- ワーカースレッドは、待機状態(ワーカーキューが0)のときにグローバルキューから接続を取得し、処理を開始します。
- ワーカースレッドがすべて動作中（=全ワーカーの負荷が高い）場合、受信スレッドは新たな分配を行わず、ワーカースレッドがメインキューをポーリングしてキューから接続を取得するのを待機します。
- ワーカースレッドはポーリングに失敗した場合待機状態に移行しポーリングを停止します。
- この設計により、過負荷時の無駄なブロッキングを抑え、低負荷時はレイテンシを向上させます。
